{% extends 'base.html' %}
{% block title %}Search Results - University of Tampa CIRT{% endblock %}

{% block content %}

    <div class="red-bar"></div>

    <div class="main-container">
    <!-- Sidebar for Filters -->
    <div class="filter-sidebar">
        <h4>Filter by Category</h4>

        <!-- Category and Subcategory Dropdowns -->
        {% for category in categories %}

        <div class="category">
            <!-- Category Checkbox -->
            <input type="checkbox" id="category-{{ category.id }}" name="category" value="{{ category.id }}">
            <label for="category-{{ category.id }}" class="category-label" onclick="toggleSubcategories('subcategory-{{ category.id }}')">
                {{ category.name }}
            </label>

            <!-- Subcategories with Checkboxes -->
            <ul id="subcategory-{{ category.id }}" class="subcategory-container">
                {% for subcategory in category.subcategories.all %}
                <li class="subcategory-item">
                    <input type="checkbox" id="subcategory-{{ subcategory.id }}" name="subcategory" value="{{ subcategory.id }}">
                    <label for="subcategory-{{ subcategory.id }}">{{ subcategory.name }}</label>
                </li>
                {% empty %}
                <li class="subcategory-item">No subcategories available</li>
                {% endfor %}
            </ul>
        </div>
        {% endfor %}

        <!-- js for Toggle -->
        <script>
            function toggleSubcategories(categoryId) {
                const element = document.getElementById(categoryId);
                if (element) {
                    element.classList.toggle('show');
                } else {
                    console.error('Element not found for ID:', categoryId);
                }
            }

        </script>

        <!-- Filter Button -->
        <button onclick="applyFilters()">Apply Filters</button>
    </div>




        <!-- Search Results Section -->
        <div id="search-results-container" style="width: 100%; overflow-y: auto; font-family: 'Times New Roman', Times, 'Serif'; ">
            <h2>Search Results</h2>
            <div id="search-results">
                <!-- Search results will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        function toggleSubcategories(categoryId) {
            const subcategories = document.getElementById(categoryId);
            if (subcategories) {
                subcategories.style.display = subcategories.style.display === 'block' ? 'none' : 'block';
            }
        }

        function applyFilters() {
            const selectedCategories = [];
            const selectedSubcategories = [];

            document.querySelectorAll('input[name="category"]:checked').forEach(checkbox => {
                selectedCategories.push(checkbox.value);
            });


            document.querySelectorAll('input[name="subcategory"]:checked').forEach( checkbox => {
                selectedSubcategories.push(checkbox.value)
            });

            const data = {
                selected_categories: selectedCategories,
                selected_subcategories: selectedSubcategories
                };

            fetch('/search-results/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken() // Token
                },
                 body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log("Filtered Documents:", data);
                updateDocuments(data);
            })
            .catch(error => console.error('Error:', error));

        }




        function getCSRFToken() {
            const cookieValue = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
            return cookieValue ? cookieValue.split('=')[1] : '';
        }



        // Display search results
        function displaySearchResults() {
            const { query, filter } = getQueryParams();
            const resultsContainer = document.getElementById("search-results-container");

            if (!query) {
                resultsContainer.innerHTML = "<p style='text-align: center;'>No search term provided.</p>";
                return;
            }

            const rawDocumentsJson = "{{ documents_json|escapejs }}";
            let documents = [];
            try {
                documents = JSON.parse(rawDocumentsJson);
            } catch (error) {
                console.error("Error parsing JSON:", error);
                resultsContainer.innerHTML = "<p style='text-align: center;'>Error loading documents.</p>";
                return;
            }

            if (documents.length === 0) {
                resultsContainer.innerHTML = `<p style='text-align: center;'>No results found for "${query}".</p>`;
                return;
            }

            let resultHTML = `<h3 style="text-align: center;">Results for: "${query}"</h3><ul style="list-style-type: none; padding: 0;">`;

            documents.forEach(result => {
                resultHTML += `
                    <li style="padding: 15px; border-bottom: 1px solid #ddd; background: white; margin: 10px 0; box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin: 5px 0;">
                            <a href="${result.file_url}" style="text-decoration: none; color: inherit;">${result.title}</a>
                        </h3>
                        <p><strong></strong> ${result.author}</p>
                        <p><strong>Category:</strong> ${result.category_name}</p>
                        <p>${result.description}</p>
                        <a class="read-more" onclick="window.location.href='${result.url}'">Continue Reading</a>

                    </li>`;
            });

            resultHTML += `</ul>`;
            resultsContainer.innerHTML = resultHTML;
        }

        function updateDocuments(rawdocuments) {
            const documentListContainer = document.getElementById("search-results-container");

            console.log(rawdocuments); // This is already a JS object, no need for JSON.parse()

            // Ensure it's an array
            if (!Array.isArray(rawdocuments.documents)) {
                console.error("Expected an array but got:", rawdocuments.documents);
                return;
            }

            documentListContainer.innerHTML = '';  // Clear existing content

            if (rawdocuments.documents.length === 0) {
                documentListContainer.innerHTML = '<p>No results found based on the filters.</p>';
                return;
            }

            rawdocuments.documents.forEach(doc => {
                const documentItem = document.createElement("div");
                documentItem.classList.add("document-item");
                documentItem.innerHTML = `
                    <li style="padding: 15px; border-bottom: 1px solid #ddd; background: white; margin: 10px 0; box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin: 5px 0;">${doc.title}</h3>
                        <p><strong>Author:</strong> ${doc.author}</p>
                        <p><strong>Category:</strong> ${doc.category_name}</p>
                        <p>${doc.description}</p>
                        <a class="read-more" onclick="window.location.href='${doc.url}'">Continue Reading</a>
                    </li>`;
                documentListContainer.appendChild(documentItem);
            });
        }


        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                query: params.get("query"),
                filter: params.get("filter")
            };
        }

        document.addEventListener("DOMContentLoaded", displaySearchResults);
    </script>

{% endblock %}

    {% comment %} <!-- Footer -->
    <div class="footer-container">
        <div class="footer-inner">
            <div class="main-title">
                <h1>EXPLORE CIRT</h1>
            </div>
            <!-- hard coded homepage.html -->
            <button onclick="window.location.href='/'"
                style="display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; cursor: pointer;">
                Back to Home
            </button>
        </div>
    </div>
</body>
</html> {% endcomment %}
